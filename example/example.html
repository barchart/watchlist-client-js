<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>

    <title>Barchart Watchlist Client API</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
    <link rel="stylesheet" href="example.css" type="text/css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.23.0/polyfill.min.js"></script>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script src="example.js"></script>

    <script type="text/javascript">
		'use strict';

        var serviceAddress = Barchart.Watchlist.WatchlistServiceAddress.DEVELOPMENT;

		var PageModel = function() {
			var that = this;

			that.gateway = null;

			that.host = ko.observable(serviceAddress.host);
			that.user = ko.observable('14172034');

			that.watchlistUser = ko.observable(null);
			that.watchlists = ko.observable([ ]);
			that.watchlist = ko.observable(null);

			that.watchlistId = ko.computed(function() {
				return that.watchlist() !== null ? that.watchlist().id : '';
            });

			that.watchlistName = ko.observable('');

			that.connected = ko.observable(false);
			that.connecting = ko.observable(false);

			that.loaded = ko.computed(function() {
				return that.watchlistUser() !== null;
            });

			that.console = ko.observableArray([ ]);

			that.clientVersion = ko.observable();
			that.serverVersion = ko.observable();

			that.activeTemplate = ko.observable('disconnected-template');

			that.symbol = ko.observable('');

			that.mode = ko.observable('View Console');

			that.address = ko.computed(function() {
				const user = that.user();
				const host = that.host();

				if (user && host) {
					return new Barchart.Watchlist.WatchlistServiceAddress('https', that.host(), 443)
                } else {
					return null;
                }
			});

			that.canConnect = ko.computed(function() {
				return !that.connecting() && !that.connected();
			});
			that.canDisconnect = ko.computed(function() {
				return that.connected();
			});

			var writeConsoleText = function(text) {
				that.console.push(text);
			};

			var writeConsoleObject = function(data) {
				that.console.push(JSON.stringify(data, null, 2));
			};

			that.connect = function() {
				that.disconnect();

                var address = that.address();

				if (!address) {
					return;
				}

				that.connecting(true);

				that.gateway = new Barchart.Watchlist.WatchlistGateway();

				var action = 'watchlistGateway.start()';

                that.gateway.start(address, Barchart.Watchlist.WatchlistJwtProvider.forDevelopment(address, that.user()))
                    .then((metadata) => {
                        writeConsoleText(action);
                        writeConsoleObject(metadata);

                        that.connecting(false);
                        that.connected(true);

                        that.clientVersion(Barchart.Watchlist.version);
                        that.serverVersion(metadata.semver);

                        that.setConsoleMode();

                        return true;
                    }).catch((e) => {
                        writeConsoleText(action);
                        writeConsoleObject(e);

                        return false;
                    }).then((read) => {
                        if (read) {
                            return that.readUser(false);
                        }
                    });
			};
			that.disconnect = function() {
				if (that.gateway === null) {
					return;
                }

                if (that.currentTokenPromise) {
	                that.currentTokenPromise = null;
                }

                if (that.currentTokenInterval) {
	                window.clearInterval(that.currentTokenInterval);

	                that.currentTokenInterval = null;
                }

                if (that.gateway) {
	                that.gateway.dispose();
	                that.gateway = null;
                }

				that.console.removeAll();

				that.watchlistUser(null);
				that.watchlists([ ]);
				that.watchlist(null);

				that.connecting(false);
				that.connected(false);

				that.activeTemplate('disconnected-template');
			};

			that.readUser = function(clear) {
				if (clear) {
					that.console.removeAll();
				}

				var action = 'watchlistGateway.readUser()';

				return that.gateway.readUser()
                    .then(function(watchlistUser) {
                        writeConsoleText(action);
                        writeConsoleObject(watchlistUser.toJSObj());

                        let watchlists = [ ];
                        let watchlist = null;

                        for (var key in watchlistUser.watchlists) {
                        	watchlists.push(watchlistUser.watchlists[key]);
                        }

                        if (watchlists.length !== 0) {
                        	watchlist = watchlists[0];
                        }

                        that.watchlistUser(watchlistUser);
	                    that.watchlists(Object.values(watchlists));
	                    that.watchlist(watchlist);
                    }).catch((e) => {
                        writeConsoleText(action);
                        writeConsoleText(e);

                        debugger;

                        that.watchlistUser(null);
                        that.watchlists([ ]);
                        that.watchlist(null);
                    });
			};
			that.writeUser = function() {
				if (!that.connected()) {
					return;
				}

				if (!that.watchlistUser()) {
					return;
				}

				var action = 'watchlistGateway.writeUser()';

				return that.gateway.writeUser(that.watchlistUser())
                    .then(function(response) {
                        writeConsoleText(action);
                        writeConsoleObject(response);
                    }).catch((e) => {
                        writeConsoleText(action);
                        writeConsoleText(e);
                    });
			};

			that.setConsoleMode = function() {
				if (!that.connected()) {
					return;
                }

                that.mode('View Console');

                that.activeTemplate('watchlist-console-template');
            };

			that.setWatchlistMode = function() {
				if (!that.connected()) {
					return;
				}

				that.mode('View Watchlist');

				that.activeTemplate('watchlist-view-template');
            };
			that.setWatchlist = function(watchlist) {
				if (!that.connected()) {
					return;
				}

				that.watchlist(watchlist);
            };
			that.addWatchlist = function() {
				if (!that.connected()) {
					return;
				}

				var id = that.watchlistName();

				if (!id) {
					return;
                }

				const watchlistUser = that.watchlistUser();

				if (watchlistUser) {
					const watchlist = watchlistUser.createWatchlist(id);
					const watchlists = [ ];

					for (var key in watchlistUser.watchlists) {
						watchlists.push(watchlistUser.watchlists[key]);
					}

					that.watchlists(Object.values(watchlists));
                    that.watchlist(watchlist);

					that.watchlistUser.valueHasMutated();
					that.watchlists.valueHasMutated();
					that.watchlist.valueHasMutated();

					that.watchlistName('');

					that.setWatchlistMode();
                }
            };
            that.removeWatchlist = function() {
	            if (!that.connected()) {
		            return;
	            }

	            var id = that.watchlistName();

	            if (!id) {
		            return;
	            }

	            const watchlistUser = that.watchlistUser();

	            if (watchlistUser) {
		            watchlistUser.removeWatchlist(id);

		            const watchlists = [ ];

		            for (var key in watchlistUser.watchlists) {
			            watchlists.push(watchlistUser.watchlists[key]);
		            }

		            that.watchlists(Object.values(watchlists));

		            that.watchlistUser.valueHasMutated();
		            that.watchlists.valueHasMutated();

		            var watchlist = that.watchlist();

		            if (watchlistUser && watchlist.id === id) {
		            	if (watchlists.length !== 0) {
		            		watchlist = watchlists[0];
                        } else {
		            		watchlist = null;
                        }

                        that.watchlist(watchlist);
			            that.watchlist.valueHasMutated();
                    }

		            that.watchlistName('');
	            }
            };

            that.addSymbol = function() {
	            if (!that.connected()) {
		            return;
	            }

	            if (!that.watchlist()) {
		            return;
	            }

	            var symbol = that.symbol();

	            if (symbol) {
	            	var entry = {
                        symbol: symbol
                    };

	            	that.watchlist().addEntry({ symbol: symbol });
		            that.watchlist.valueHasMutated();

		            that.symbol('');
                }
			};
            that.removeEntry = function(entry) {
	            if (!that.connected()) {
		            return;
	            }

	            if (!that.watchlist()) {
		            return;
	            }

	            that.watchlist().removeEntry(entry);
	            that.watchlist.valueHasMutated();
            };
            that.getDisplayText = function(text) {
                return text ? text : '[not specified]';
            };

			that.handleLoginKeypress = function(d, e) {
				var enterKey = e.keyCode === 13;

				if (enterKey) {
					that.connect();
				}

				return !enterKey;
			};
		};

		$(document).ready(function() {
			var pageModel = new PageModel();

            ko.applyBindings(pageModel, $('body')[0]);
		});
    </script>

    <script type="text/html" id="disconnected-template">
        <div class="container-center-outer">
            <div class="container-center-inner">
                <form class="form-horizontal login">
                    <div class="form-group" data-bind="css: { 'has-error': host().length === 0 }, event: { keypress: handleLoginKeypress }">
                        <label class="pull-left">Host</label>
                        <input class="form-control" data-bind="textInput: host" type="text" placeholder="Server">
                    </div>
                    <div class="form-group" data-bind="css: { 'has-error': user().length === 0 }, event: { keypress: handleLoginKeypress }">
                        <label class="pull-left">User</label>
                        <input class="form-control" data-bind="textInput: user" type="text" placeholder="User">
                    </div>
                    <div class="form-group buttons">
                        <button class="form-control btn btn-primary" type="button" data-bind="click: connect, enable: canConnect">Connect</button>
                    </div>
                </form>
            </div>
        </div>
    </script>

    <script type="text/html" id="watchlist-header-template">
        <div class="pull-left">
            <h4 class="pull-left">Barchart Watchlist API <span data-bind="visible: connected"> -- <span data-bind="text: user"></span></span></h4>

            <div class="pull-right" data-bind="visible: connected() === true && loaded() === true">
                <div class="header-action-buttons form-inline">
                    <span class="text-button glyphicon glyphicon-floppy-disk" data-bind="click: writeUser"></span>
                </div>
            </div>

            <div class="pull-right" data-bind="visible: connected() === true && loaded() === true && mode() === 'View Watchlist'">
                <div class="header-action-buttons form-inline">
                    <div class="input-group">
                        <input class="form-control" data-bind="textInput: symbol" type="text" placeholder="Add Symbol">
                        <span class="input-group-addon glyphicon glyphicon-plus" data-bind="click: addSymbol"></span>
                    </div>
                </div>
            </div>

            <div class="pull-right" data-bind="visible: connected() === true && loaded() === true && mode() === 'View Watchlist'">
                <div class="header-action-buttons form-inline">
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary form-control" data-bind="text: watchlistId"></button>
                        <button type="button" class="btn btn-primary dropdown-toggle form-control" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="caret"></span>
                            <span class="sr-only"></span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-right" data-bind="foreach: watchlists">
                            <li><a href="#" data-bind="click: function() { $parent.setWatchlist($data); }, text: $data.id"></a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="pull-right" data-bind="visible: connected() === true && loaded() === true">
                <div class="header-action-buttons form-inline">
                    <div class="input-group">
                        <span class="input-group-addon glyphicon glyphicon-minus" data-bind="click: removeWatchlist"></span>
                        <input class="form-control" data-bind="textInput: watchlistName" type="text" placeholder="Watchlist Name">
                        <span class="input-group-addon glyphicon glyphicon-plus" data-bind="click: addWatchlist"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="pull-right">
            <div class="header-action-buttons pull-right form-inline" data-bind="visible: connected() === true && loaded() === true">
                <span class="text-button glyphicon glyphicon-remove" data-bind="click: disconnect"></span>
            </div>

            <div class="header-action-buttons pull-right form-inline" data-bind="visible: connected() === true && loaded() === true">
                <div class="btn-group">
                    <button type="button" class="btn btn-primary form-control" data-bind="text: mode"></button>
                    <button type="button" class="btn btn-primary dropdown-toggle form-control" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="caret"></span>
                        <span class="sr-only"></span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-right">
                        <li><a href="#" data-bind="click: setConsoleMode">View Console</a></li>
                        <li><a href="#" data-bind="click: setWatchlistMode">View Watchlist</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </script>

    <script type="text/html" id="watchlist-console-template">
        <div data-bind="foreach: console">
            <pre data-bind="text: $data" style="font-size: 10px;"></pre>
        </div>
    </script>

    <script type="text/html" id="watchlist-view-template">
        <!-- ko if: watchlist() !== null -->
        <table class="table table-striped small">
            <thead>
            <th class="left col-md-1"></th>
            <th class="left col-md-2">Symbol</th>
            <th class="left col-md-2">TGAM Symbol</th>
            <th class="left col-md-2">TGAM Listing ID</th>
            </thead>
            <tbody data-bind="template: { name: 'watchlist-entry-template', foreach: watchlist().entries }"></tbody>
        </table>
        <!-- /ko -->
    </script>

    <script type="text/html" id="watchlist-entry-template">
        <tr>
            <td class="center col-md-1 watchlist-action-buttons">
                <span class="text-button text-button-black glyphicon glyphicon-remove" data-bind="click: function() { $parent.removeEntry($data); }"></span>
            </td>
            <td class="left col-md-2" data-bind="text: $parent.getDisplayText($data.symbol)"></td>
            <td class="left col-md-2" data-bind="text: $parent.getDisplayText($data.tgam_symbol)"></td>
            <td class="left col-md-2" data-bind="text: $parent.getDisplayText($data.tgam_listing_id)"></td>
        </tr>
    </script>


    <script type="text/html" id="footer-template">
        <!-- ko if: address() !== null -->
        <h4 class="pull-left" data-bind="visible: connected">
            <span><span data-bind="text: address().host"></span>:<span data-bind="text: address().port"></span></span>
        </h4>
        <h4 class="pull-right">Client Version: <span data-bind="text: clientVersion"></span>; API Version: <span data-bind="text: serverVersion"></span></h4>
        <!-- /ko -->
    </script>
</head>
<body>
<div class="header" data-bind="template: { name: 'watchlist-header-template' }"></div>
<div class="main" data-bind="template: { name: activeTemplate }"></div>
<div class="footer" data-bind="template: { name: 'footer-template' }">
</div>
</body>
</html>